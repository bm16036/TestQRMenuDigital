<section class="feature">
  <header class="feature__header">
    <div>
      <h1>Usuarios</h1>
      <p>Administra los accesos al panel para cada empresa.</p>
    </div>
    <button type="button" class="feature__reset" *ngIf="selectedUserId()" (click)="cancelEdit()">
      Cancelar edición
    </button>
  </header>

  <div class="feature__grid">
    <section class="panel">
      <h2>{{ selectedUserId() ? 'Editar usuario' : 'Nuevo usuario' }}</h2>

      <form [formGroup]="userForm" (ngSubmit)="save()" class="form">
        <label class="form__field">
          <span>Nombre completo</span>
          <input type="text" formControlName="fullName" placeholder="Ej. Juan Pérez" />
          <small class="form__error" *ngIf="userForm.get('fullName')?.invalid && userForm.get('fullName')?.touched">
            Ingresa un nombre válido.
          </small>
        </label>

        <label class="form__field">
          <span>Correo electrónico</span>
          <input type="email" formControlName="username" placeholder="usuario@empresa.com" />
          <small class="form__error" *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched">
            Ingresa un correo válido.
          </small>
        </label>

        <label class="form__field">
          <span>Rol</span>
          <select formControlName="role">
            <option value="ADMIN">Administrador</option>
            <option value="USER">Usuario</option>
          </select>
          <small class="form__error" *ngIf="userForm.get('role')?.invalid && userForm.get('role')?.touched">
            Selecciona el rol que tendrá el usuario.
          </small>
        </label>

        <label class="form__field">
          <span>Empresa</span>
          <select formControlName="companyId">
            <option value="" disabled>Selecciona una empresa</option>
            <option *ngFor="let company of companies()" [value]="company.id">
              {{ company.commercialName }}
            </option>
          </select>
          <small class="form__error" *ngIf="userForm.get('companyId')?.invalid && userForm.get('companyId')?.touched">
            Selecciona la empresa a la que pertenece el usuario.
          </small>
        </label>

        <label class="form__field" *ngIf="!selectedUserId()">
          <span>Contraseña temporal</span>
          <input type="password" formControlName="password" placeholder="Se solicitará cambio al iniciar sesión" />
          <small class="form__error" *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
            La contraseña debe tener al menos 8 caracteres.
          </small>
        </label>

        <label class="form__checkbox">
          <input type="checkbox" formControlName="active" />
          <span>Cuenta activa</span>
        </label>

        <button type="submit" class="form__submit" [disabled]="isSaving()">
          {{ isSaving() ? 'Guardando...' : 'Guardar usuario' }}
        </button>

        <p class="form__feedback" *ngIf="feedbackMessage()">{{ feedbackMessage() }}</p>
      </form>
    </section>

    <section class="panel">
      <h2>Listado de usuarios</h2>

      <table class="table" *ngIf="users().length; else emptyState">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Rol</th>
            <th>Estado</th>
            <th class="table__actions">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users()">
            <td>{{ user.fullName }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.role }}</td>
            <td>
              <span class="status" [class.status--active]="user.active">
                {{ user.active ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
            <td class="table__actions">
              <button type="button" (click)="edit(user)">Editar</button>
              <button type="button" class="danger" (click)="delete(user.id)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>

      <ng-template #emptyState>
        <p class="panel__empty">Aún no se han registrado usuarios.</p>
      </ng-template>
    </section>
  </div>
</section>
